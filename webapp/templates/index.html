<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>{{ title }}</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles.css?salt={{ salt }}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="/effects.js?salt={{ salt }}"></script>
    <script src="/utils.js?salt={{ salt }}"></script>
    <script src="/js/chat.js?salt={{ salt }}"></script>
    <script src="/engine.js?salt={{ salt }}"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <style>
        .image-container {
          position: absolute;
          top: {{ tile_size_px }}px;
          left: {{ tile_size_px }}px;
          height: {{ background_height }}px;
        }

        .image-container img.background-image {
          width: {{ background_width }}px;
        }

        /* Draggable panel styles */
        .draggable-panel {
          transition: transform 0.1s ease-out;
          user-select: none;
        }

        .draggable-panel.dragging {
          transition: none;
          cursor: move;
        }

        .draggable-panel .panel-header {
          cursor: move;
          user-select: none;
        }

        .draggable-panel .panel-header:hover {
          background-color: #e9ecef;
        }

        /* Chat message styles */
        .chat-message {
          margin-bottom: 8px;
          padding: 4px 0;
          word-wrap: break-word;
        }

        .chat-message.user {
          color: #2c3e50;
        }

        .chat-message.assistant {
          color: #27ae60;
        }

        .chat-message.system {
          color: #7f8c8d;
          font-style: italic;
        }

        .chat-message.processing {
          color: #f39c12;
        }

        /* Scrollbar styling for chat messages */
        #draggable-chat-messages::-webkit-scrollbar {
          width: 6px;
        }

        #draggable-chat-messages::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 3px;
        }

        #draggable-chat-messages::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 3px;
        }

        #draggable-chat-messages::-webkit-scrollbar-thumb:hover {
          background: #a8a8a8;
        }

        /* Target selection modal styles */
        .target-option {
          display: flex;
          align-items: center;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 5px;
          margin-bottom: 5px;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .target-option:hover {
          background-color: #f8f9fa;
        }

        .target-option.selected {
          background-color: #007bff;
          color: white;
          border-color: #007bff;
        }

        .target-image {
          width: 40px;
          height: 40px;
          margin-right: 10px;
          border-radius: 3px;
          object-fit: cover;
        }

        .target-info {
          flex: 1;
        }

        .target-name {
          font-weight: bold;
          margin-bottom: 2px;
        }

        .target-type {
          font-size: 0.9em;
          opacity: 0.7;
        }

        .target-option.selected .target-type {
          opacity: 0.9;
        }
    </style>
</head>
<body data-soundtrack-id="{{ soundtrack.name }}" data-soundtrack-url="{{soundtrack.file}}" data-soundtrack-time="{{soundtrack.time}}" data-soundtrack-volume="{{ soundtrack.volume }}" data-battle_in_progress="{{ 'true' if battle else 'false' }}"
      data-current-map="{{ current_map }}"
      data-pov-entity="{{ current_pov }}"
      data-waiting-for-reaction="{{ 'true' if waiting_for_reaction else 'false' }}"
      data-username="{{ username }}" data-role="{{ role }}" data-controls="{{ entity_ids }}">
    <div id="reaction-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <form id="reaction-form"  method="post" action="/reaction" class="form-horizontal" role="form" style="margin-top: 20px;" data-remote="true">
                        <div class="reaction-content">
                            {% if waiting_for_reaction %}
                                {% include "reactions/" ~ waiting_for_reaction[1].reaction_type ~ ".html" %}
                            {% endif %}
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="floating-menu">
        <button id="expand-menu" class="menu-button">
            <span class="glyphicon glyphicon-menu-hamburger"></span>
        </button>
        <button id="collapse-menu" class="menu-button" style="display: none;">
            <span class="glyphicon glyphicon-menu-left"></span>
        </button>
        <div id="menu" style="display: none;">
            <ul>
                {% if 'dm' in role %}
                    <li id="select-soundtrack">Sound Manager</li>
                    <li id="start-battle" style="{{ 'display: none;' if battle}}">Start Battle</li>
                    <li id="end-battle" style="{{ 'display: none;' if not battle}}">End Battle</li>
                    <li id="switch-map" data-toggle="modal" data-target="#mapModal">Switch Map</li>
                    <li id="reload-map" data-toggle="modal" data-target="#reloadModal">Reload Map</li>
                    <li id="send-command" data-toggle="modal" data-target="#commandModal">Send Command</li>
                {% endif %}
                <li id="open-console">Open Console</li>
                <li>
                    <form action="/logout" method="post">
                        <input type="submit" value="Logout">
                    </form>
                </li>
            </ul>
        </div>
    </div>
    {% if 'dm' in role %}
    <div id="reloadModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="reloadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="reloadModelLabel">Reload Map</h4>
                </div>
                <div class="modal-body">
                    <form id="reload-map-form">
                        <button type="submit" class="btn btn-primary">Reload Map</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="mapModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="mapModalLabel">Select a Map</h4>
                </div>
                <div class="modal-body">
                    <form id="map-selection-form">
                        <div class="form-group">
                            <label for="map-select">Available Maps</label>
                            <select id="map-select" name="map" class="form-control">
                                {% for map in available_maps %}
                                    <option value="{{ map }}">{{ map }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
    <div id="coords-box" style="position: fixed; top: 0; right: 0; background-color: white; padding: 10px; border: 1px solid black;"></div>
    <div id="main-map-area" style="background-color: {{ background_color }}; position: relative; width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: auto;">
        <div class="image-container" style="position: relative; height: {{ background_height }}px;">
            {% if background_path.endswith('.mp4') %}
                <video autoplay loop muted playsinline style="width: {{ background_width }}px; height: inherit; object-fit: cover; object-position: top;">
                    <source src="{{ background_path }}" type="video/mp4">
                </video>
            {% else %}
                <img src="{{ background_path }}" class="background-image" style="width: {{ background_width }}px; object-fit: cover; object-position: top;">
            {% endif %}
            <div id="tiles-area" class="tiles-container actions-container" data-width="{{ background_width }}" data-height="{{ background_height }}" data-tile-size="{{tile_size_px}}" style="position: absolute; top: -{{tile_size_px}}px; left: -{{tile_size_px}}px;"></div>
        </div>
    </div>
    <div class="modal fade" id="modal-1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content actions-container">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Target Selection Modal -->
    <div class="modal fade" id="targetSelectionModal" tabindex="-1" role="dialog" aria-labelledby="targetSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="targetSelectionModalLabel">Select Target</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Multiple valid targets found at this location. Please select which one to target:</p>
                    <div id="targetList" class="list-group">
                        <!-- Target options will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Select Target</button>
                </div>
            </div>
        </div>
    </div>
    <div id="battle-turn-order" class="floating-window" style="{{ 'display: none;' if battle is none }}">
        <div class="header" style="cursor: move;">Battle Turn Order</div>

        <div id="turn-order">
            {% if not battle %}
                <button id="start-initiative" class="btn btn-primary" style="margin-top: 20px;">Roll Initiative!</button>
                <!-- <button id="add-all-entities" class="btn btn-primary" style="margin-top: 20px;">Add Everyone in Map</button> -->
            {% endif %}
            {% if battle%}
                {% include 'battle.html' %}
            {% endif %}
        </div>
    </div>
    <div id="console-container" class="floating-window" style="display: none;">
        <div class="header" style="cursor: move; display: flex; justify-content: space-between; align-items: center;">
            <span>Combat Log</span>
            <div>
                <a href="/combat-log" target="_blank" style="text-decoration: none;">
                    <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span>
                </a>
                <button id="hide-combat-log" class="btn btn-default" style="margin-left: 5px;">
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                </button>
            </div>
        </div>
        <div id="console" class="console">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    </div>

    {% if battle %}
        <div class="game-turn-container" style="pointer-events: none;">
        {% include 'turn.jinja' %}
        </div>
    {% else %}
        <div class="game-turn-container"></div>
    {% endif %}
    <span id="zoom-controls" class="btn-group">
        <button class="btn btn-default zoom-in">
            <span class="glyphicon glyphicon-zoom-in"></span>
        </button>
        <button class="btn btn-default zoom-out">
            <span class="glyphicon glyphicon-zoom-out"></span>
        </button>
    </span>
    <button id="toggle-portraits" class="btn btn-default portrait-button">Show/Hide Characters</button>
    <div id="floating-entity-portraits">
        {% include 'floating_portraits.html' %}
    </div>
    <script>
      (function() {
        const toggleButton = document.getElementById('toggle-portraits');
        const portraitsContainer = document.getElementById('floating-entity-portraits');
        // Toggle portraits visibility
        toggleButton.addEventListener('click', function() {
          if (portraitsContainer.style.display === 'none') {
            portraitsContainer.style.display = 'block';
          } else {
            portraitsContainer.style.display = 'none';
          }
        });
      })();
    </script>
    <div id="commandModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="commandModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
               <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title" id="commandModalLabel">DM Console</h4>
          </div>
          <div class="modal-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="dmConsoleTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <a class="nav-link active" id="command-tab" data-toggle="tab" href="#command-panel" role="tab" aria-controls="command-panel" aria-selected="true">
                  <i class="glyphicon glyphicon-console"></i> Command Console
                </a>
              </li>
              <li class="nav-item" role="presentation">
                <a class="nav-link" id="ai-tab" data-toggle="tab" href="#ai-panel" role="tab" aria-controls="ai-panel" aria-selected="false">
                  <i class="glyphicon glyphicon-comment"></i> AI Assistant
                </a>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="dmConsoleTabContent">
              <!-- Command Console Tab -->
              <div class="tab-pane fade show active" id="command-panel" role="tabpanel" aria-labelledby="command-tab">
                <form id="command-form">
                  <div class="form-group">
                    <label for="command-input">Command</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="command-input" placeholder="Type your command here">
                      <span class="input-group-btn">
                        <button class="btn btn-primary" type="submit">
                          <i class="glyphicon glyphicon-play"></i> Execute
                        </button>
                      </span>
                    </div>
                  </div>
                  <div id="command-output" style="white-space: pre-wrap; background: #eee; padding: 10px; height: 200px; overflow-y: auto;"></div>
                </form>
              </div>
              
              <!-- AI Assistant Tab -->
              <div class="tab-pane fade" id="ai-panel" role="tabpanel" aria-labelledby="ai-tab">
                <!-- AI Configuration Section -->
                <div class="ai-config-section" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                  <h5><i class="glyphicon glyphicon-cog"></i> AI Configuration</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="ai-provider-select">Provider</label>
                        <select class="form-control" id="ai-provider-select">
                          <option value="mock">Mock (Testing)</option>
                          <option value="ollama">Ollama (Local)</option>
                          <option value="openai">OpenAI GPT</option>
                          <option value="anthropic">Anthropic Claude</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="ai-api-key">API Key / URL</label>
                        <input type="text" class="form-control" id="ai-api-key" placeholder="Enter API key or Ollama URL">
                        <small class="form-text text-muted">For Ollama, leave empty for localhost:11434 or enter custom URL</small>
                      </div>
                    </div>
                  </div>
                  <div class="row" id="model-selection-row" style="display: none; margin-bottom: 10px;">
                    <div class="col-xs-8">
                      <div class="form-group" style="margin-bottom: 0;">
                        <label for="ai-model-select" style="font-size: 12px;">Model:</label>
                        <select class="form-control input-sm" id="ai-model-select" style="font-size: 12px;">
                          <option value="">Loading models...</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-xs-4">
                      <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">&nbsp;</label>
                        <button type="button" class="btn btn-xs btn-info" id="draggable-refresh-models" style="width: 100%;">
                          <i class="glyphicon glyphicon-refresh"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-primary" id="initialize-ai">
                    <i class="glyphicon glyphicon-play"></i> Initialize AI
                  </button>
                  <span id="ai-status" class="label label-default" style="margin-left: 10px;">Not initialized</span>
                </div>
                
                <!-- Chat Interface -->
                <div class="chat-interface">
                  <div id="chat-messages" style="height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff; margin-bottom: 10px;">
                    <div class="chat-message system">
                      <strong>AI Assistant:</strong> Welcome! I'm here to help you with your D&D game. I can assist with game mechanics, story development, battle management, and more. What would you like help with?
                    </div>
                  </div>
                  
                  <form id="chat-form">
                    <div class="input-group">
                      <input type="text" class="form-control" id="chat-input" placeholder="Ask me anything about your D&D game..." disabled>
                      <span class="input-group-btn">
                        <button class="btn btn-primary" type="submit" id="send-chat" disabled>
                          <i class="glyphicon glyphicon-send"></i> Send
                        </button>
                      </span>
                    </div>
                  </form>
                  
                  <div style="margin-top: 10px;">
                    <button type="button" class="btn btn-sm btn-default" id="clear-chat">
                      <i class="glyphicon glyphicon-trash"></i> Clear Chat
                    </button>
                    <button type="button" class="btn btn-sm btn-info" id="get-context">
                      <i class="glyphicon glyphicon-info-sign"></i> Get Game Context
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Talk Modal -->
<div class="modal fade" id="talkModal" tabindex="-1" role="dialog" aria-labelledby="talkModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="talkModalLabel">Add to Conversation</h4>
      </div>
      <div class="modal-body">
        <form id="talkForm">
          <div class="form-group">
            <label for="talkMessage">Message:</label>
            <textarea class="form-control" id="talkMessage" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="languageSelect">Language:</label>
            <select class="form-control" id="languageSelect" required>
              <!-- Languages will be populated here -->
            </select>
          </div>
          <div class="form-group">
            <label>Speech Volume:</label>
            <div class="radio">
              <label>
                <input type="radio" name="speechVolume" value="whisper" data-distance="5"> Whisper (5ft)
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="speechVolume" value="normal" data-distance="30" checked> Normal (30ft)
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="speechVolume" value="shout" data-distance="60"> Shout (60ft)
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Directed to:</label>
            <div id="nearbyEntities" class="list-group">
              <!-- Nearby entities will be populated here -->
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitTalk">Submit</button>
      </div>
    </div>
  </div>
</div>

    <!-- JRPG Dialog Panel (Draggable) -->
<div id="jrpgDialogPanel" class="draggable-dialog-panel" style="display: none; position: fixed; top: 100px; left: 50px; width: 800px; height: 600px; z-index: 1000; background: white; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;">
  <div class="dialog-panel-header" style="padding: 10px; border-bottom: 1px solid #ddd; border-radius: 6px 6px 0 0; cursor: move; user-select: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h5 style="margin: 0; color: #333;">
        <i class="glyphicon glyphicon-comment"></i> <span id="jrpgDialogPanelLabel">Dialog</span>
        <span id="dialogModeIndicator" class="mode-indicator" style="display: none;">
          <i class="glyphicon glyphicon-user"></i> Talk Mode
        </span>
      </h5>
      <div>
        <button type="button" class="btn btn-xs btn-default" id="minimize-dialog" title="Minimize">
          <i class="glyphicon glyphicon-minus"></i>
        </button>
        <button type="button" class="btn btn-xs btn-default" id="close-dialog" title="Close">
          <i class="glyphicon glyphicon-remove"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div class="dialog-panel-body" style="padding: 15px; height: calc(100% - 60px); display: flex; flex-direction: column; overflow: hidden;">
    <div class="jrpg-dialog-container">
      <!-- Entity Profile Panel (Left Side) -->
      <div class="entity-profile-panel">
        <div class="entity-portrait">
          <img id="dialogEntityPortrait" src="" alt="Entity Portrait" class="portrait-image">
        </div>
        <div class="entity-info">
          <h3 id="dialogEntityName" class="entity-name">Entity Name</h3>
          <div class="entity-description">
            <p id="dialogEntityDescription" class="description-text">Entity description will appear here.</p>
          </div>
        </div>
      </div>
      
      <!-- Chat Interface (Right Side) -->
      <div class="chat-interface-panel">
        <div class="chat-messages-container">
          <div id="dialogChatMessages" class="dialog-chat-messages">
            <!-- Chat messages will appear here -->
          </div>
        </div>
        <div class="chat-input-container">
          <div class="chat-input-row">
            <div class="language-selector">
              <select class="form-control" id="dialogLanguageSelect">
                <option value="Common" selected>Common</option>
              </select>
            </div>
            <div class="input-group">
              <input type="text" class="form-control" id="dialogChatInput" placeholder="Type your message..." maxlength="200">
              <span class="input-group-btn">
                <button class="btn btn-primary" type="button" id="dialogSendMessage">
                  <i class="glyphicon glyphicon-send"></i> Send
                </button>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Resize handle -->
  <div class="dialog-resize-handle" style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: se-resize; background: linear-gradient(135deg, transparent 50%, #ccc 50%);"></div>
</div>

    <!-- only for DMs -->
     {% if is_dm %}
    <!-- Draggable AI Chatbot Interface -->
    <div id="ai-chat-panel" class="draggable-panel" style="display: none; position: fixed; top: 100px; right: 20px; width: 400px; height: 600px; z-index: 1000; background: white; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;">
      <div class="panel-header" style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd; border-radius: 6px 6px 0 0; cursor: move; user-select: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h5 style="margin: 0; color: #333;">
            <i class="glyphicon glyphicon-comment"></i> AI Assistant
          </h5>
          <div>
            <button type="button" class="btn btn-xs btn-default" id="minimize-chat" title="Minimize">
              <i class="glyphicon glyphicon-minus"></i>
            </button>
            <button type="button" class="btn btn-xs btn-default" id="close-chat" title="Close">
              <i class="glyphicon glyphicon-remove"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="panel-body" style="padding: 15px; height: calc(100% - 60px); display: flex; flex-direction: column; overflow: hidden;">
        <!-- AI Configuration Section -->
        <div class="ai-config-section" style="margin-bottom: 15px; flex-shrink: 0;">
          <h6 style="margin-top: 0; margin-bottom: 10px; color: #333;">AI Configuration</h6>
          
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="draggable-ai-provider-select" style="font-size: 12px;">Provider:</label>
            <select class="form-control input-sm" id="draggable-ai-provider-select" style="font-size: 12px;">
              <option value="mock">Mock (Test)</option>
              <option value="openai">OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="ollama">Ollama (Local)</option>
            </select>
          </div>
          
          <div class="form-group" style="margin-bottom: 10px;">
            <label for="draggable-ai-api-key" style="font-size: 12px;">API Key/URL:</label>
            <input type="text" class="form-control input-sm" id="draggable-ai-api-key" placeholder="Enter API key or Ollama URL" style="font-size: 12px;">
            <small class="help-block" style="font-size: 11px; margin-top: 2px;"></small>
          </div>
          
          <div class="row" id="draggable-model-selection-row" style="display: none; margin-bottom: 10px;">
            <div class="col-xs-8">
              <div class="form-group" style="margin-bottom: 0;">
                <label for="draggable-ai-model-select" style="font-size: 12px;">Model:</label>
                <select class="form-control input-sm" id="draggable-ai-model-select" style="font-size: 12px;">
                  <option value="">Loading models...</option>
                </select>
              </div>
            </div>
            <div class="col-xs-4">
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px;">&nbsp;</label>
                <button type="button" class="btn btn-xs btn-info" id="draggable-refresh-models" style="width: 100%;">
                  <i class="glyphicon glyphicon-refresh"></i>
                </button>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 10px;">
            <button type="button" class="btn btn-xs btn-primary" id="draggable-initialize-ai">
              <i class="glyphicon glyphicon-play"></i> Initialize AI
            </button>
            <span id="draggable-ai-status" class="label label-default" style="margin-left: 10px; font-size: 11px;">Not initialized</span>
          </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="chat-interface" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
          <div id="draggable-chat-messages" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 8px; background: #fff; margin-bottom: 8px; font-size: 12px; min-height: 0;">
            <div class="chat-message system">
              <strong>AI Assistant:</strong> Welcome! I'm here to help you with your D&D game. Initialize the AI to get started.
            </div>
          </div>
          
          <form id="draggable-chat-form" style="margin-bottom: 8px; flex-shrink: 0;">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="draggable-chat-input" placeholder="Ask me anything..." disabled style="font-size: 12px;">
              <span class="input-group-btn">
                <button class="btn btn-primary btn-sm" type="submit" id="draggable-send-chat" disabled style="font-size: 12px;">
                  <i class="glyphicon glyphicon-send"></i>
                </button>
              </span>
            </div>
          </form>
          
          <div style="display: flex; gap: 5px; flex-shrink: 0;">
            <button type="button" class="btn btn-xs btn-default" id="draggable-clear-chat">
              <i class="glyphicon glyphicon-trash"></i> Clear
            </button>
            <button type="button" class="btn btn-xs btn-info" id="draggable-get-context">
              <i class="glyphicon glyphicon-info-sign"></i> Context
            </button>
          </div>
        </div>
      </div>
      
      <!-- Resize handle -->
      <div class="resize-handle" style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: se-resize; background: linear-gradient(135deg, transparent 50%, #ccc 50%);"></div>
    </div>

    <!-- AI Chat Toggle Button -->
    <button id="toggle-ai-chat" class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; border-radius: 50%; width: 50px; height: 50px; padding: 0; font-size: 18px;">
      <i class="glyphicon glyphicon-comment"></i>
    </button>
    {% endif %}
</body>
</html>
